<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ProElements Compatibility Fixes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ProElements Compatibility Fixes Test</h1>
    
    <div class="test-result info">
        <h3>üß™ Testing import.meta polyfill</h3>
        <div id="import-meta-test">Loading...</div>
    </div>
    
    <div class="test-result info">
        <h3>üß™ Testing postMessage DataCloneError fix</h3>
        <div id="postmessage-test">Loading...</div>
    </div>
    
    <div class="test-result info">
        <h3>üß™ Testing element creation fix</h3>
        <div id="element-test">Loading...</div>
    </div>
    
    <div class="test-result info">
        <h3>üìã Console Messages</h3>
        <pre id="console-output">Console messages will appear here...</pre>
    </div>

    <!-- Simulate ProElements compatibility fixes -->
    <script src="/wp-content/plugins/proelements/assets/js/compatibility-fixes.js"></script>
    
    <script>
        // Capture console messages
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-output');
        let messages = [];
        
        function addConsoleMessage(type, ...args) {
            const message = `[${type.toUpperCase()}] ${args.join(' ')}`;
            messages.push(message);
            consoleOutput.textContent = messages.slice(-10).join('\n');
        }
        
        console.log = function(...args) {
            addConsoleMessage('log', ...args);
            originalLog.apply(console, args);
        };
        
        console.warn = function(...args) {
            addConsoleMessage('warn', ...args);
            originalWarn.apply(console, args);
        };
        
        console.error = function(...args) {
            addConsoleMessage('error', ...args);
            originalError.apply(console, args);
        };
        
        // Test 1: import.meta polyfill
        function testImportMeta() {
            const testDiv = document.getElementById('import-meta-test');
            try {
                if (typeof window.importMeta !== 'undefined') {
                    testDiv.innerHTML = `
                        <div class="success">‚úÖ import.meta polyfill exists</div>
                        <pre>URL: ${window.importMeta.url}
Environment: ${JSON.stringify(window.importMeta.env, null, 2)}</pre>
                    `;
                    
                    // Test import.meta usage
                    if (typeof globalThis.import !== 'undefined' && globalThis.import.meta) {
                        testDiv.innerHTML += '<div class="success">‚úÖ globalThis.import.meta available</div>';
                    }
                } else {
                    testDiv.innerHTML = '<div class="error">‚ùå import.meta polyfill not found</div>';
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">‚ùå Error testing import.meta: ${error.message}</div>`;
            }
        }
        
        // Test 2: postMessage DataCloneError fix
        function testPostMessage() {
            const testDiv = document.getElementById('postmessage-test');
            try {
                // Create a URL object that would normally cause DataCloneError
                const testURL = new URL(window.location.href);
                const testMessage = {
                    data: 'test',
                    url: testURL,
                    timestamp: new Date()
                };
                
                // Try to post message - this should not throw DataCloneError
                window.postMessage(testMessage, '*');
                testDiv.innerHTML = '<div class="success">‚úÖ postMessage DataCloneError fix working</div>';
            } catch (error) {
                testDiv.innerHTML = `<div class="error">‚ùå postMessage test failed: ${error.message}</div>`;
            }
        }
        
        // Test 3: Element creation fix
        function testElementCreation() {
            const testDiv = document.getElementById('element-test');
            try {
                // Test creating missing elementor container
                const documentId = '346';
                const selector = `.elementor-${documentId}`;
                
                // Remove existing container if any
                const existing = document.querySelector(selector);
                if (existing) existing.remove();
                
                // This should trigger automatic container creation
                let container = document.querySelector(selector);
                if (!container) {
                    // Simulate the fix
                    container = document.createElement('div');
                    container.className = `elementor elementor-${documentId}`;
                    container.dataset.elementorType = 'wp-page';
                    container.dataset.elementorId = documentId;
                    document.body.appendChild(container);
                }
                
                if (container) {
                    testDiv.innerHTML = `
                        <div class="success">‚úÖ Element creation fix working</div>
                        <div>Created container: ${container.className}</div>
                    `;
                } else {
                    testDiv.innerHTML = '<div class="error">‚ùå Element creation test failed</div>';
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">‚ùå Element creation test error: ${error.message}</div>`;
            }
        }
        
        // Run tests when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                testImportMeta();
                testPostMessage();
                testElementCreation();
            }, 1000);
        });
        
        // Test import.meta directly (this should not throw an error now)
        try {
            console.log('Testing import.meta access...');
            if (typeof import !== 'undefined' && import.meta) {
                console.log('import.meta is available:', import.meta);
            } else {
                console.log('import.meta polyfilled via window.importMeta');
            }
        } catch (error) {
            console.error('import.meta test failed:', error);
        }
    </script>
</body>
</html>
